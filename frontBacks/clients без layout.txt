<!DOCTYPE html>
<html xmlns:th="https://www.thymeleaf.org" lang="ru">
<link rel="stylesheet" th:href="@{/style.css}">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
<head>
    <title>Клиенты</title>
    <style>
        table td, table th {
            padding: 10px;
        }

        /* Стили для кнопок */
        .add-btn {
            padding: 8px 15px;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            margin-bottom: 15px;
            cursor: pointer;
        }

        .edit-btn, .delete-btn {
            padding: 5px 10px;
            cursor: pointer;
            border: none;
            border-radius: 4px;
            margin-right: 5px;
        }

        .edit-btn {
            background-color: #4CAF50;
            color: white;
        }

        .delete-btn {
            background-color: #f44336;
            color: white;
        }

        /* Стили для модальных окон */
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.4);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 50%;
            border-radius: 5px;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
        }

        .form-group input {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
        }
    </style>
</head>
<body>
<!-- Боковая панель -->
<aside class="sidebar">
    <div class="sidebar-header">
        <h2>Гостевой дом</h2>
    </div>
    <ul class="sidebar-nav">
        <li><a href="/"><i class="bi bi-list-ul"></i> Главная</a></li>
        <li><a href="/clients" class="active"><i class="bi bi-people-fill"></i> Клиенты</a></li>
        <li><a href="#"><i class="bi bi-house-fill"></i> Дома</a></li>
        <li><a href="#"><i class="bi bi-bicycle"></i> Услуги</a></li>
        <li><a href="#"><i class="bi bi-calendar2-check-fill"></i> Аренды</a></li>
        <li><a href="#"><i class="bi bi-clipboard-fill"></i> Заказы</a></li>
    </ul>
</aside>

<!-- Основное содержимое -->
<main class="main-content">

    <h1>Список клиентов</h1>
    <br>
    <button class="add-btn" onclick="openModal('addModal')">Добавить клиента</button>

    <table>
        <thead>
        <tr>
            <th>ФИО</th>
            <th>Телефон</th>
            <th>Действия</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="client, iterStat : ${clients}" th:attr="data-id=${client.id}">
            <td th:text="${client.name}"></td>
            <td th:text="${client.phoneNumber}"></td>
            <td>
                <button class="edit-btn"
                        th:attr="data-id=${client.id}, data-name=${client.name}, data-phone=${client.phoneNumber}"
                        onclick="openEditModal(this)">
                    <i class="bi bi-pencil"></i>
                </button>
                <button class="delete-btn"
                        th:attr="data-id=${client.id}"
                        onclick="confirmDelete(this)">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
        </tr>
        </tbody>
    </table>

    <!-- Модальное окно добавления -->
    <div id="addModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('addModal')">&times;</span>
            <h2>Добавить клиента</h2>
            <form id="addForm">
                <div class="form-group">
                    <label for="addName">ФИО:</label>
                    <input type="text" id="addName" required>
                </div>
                <div class="form-group">
                    <label for="addPhone">Телефон:</label>
                    <input type="text" id="addPhone" required>
                </div>
                <button type="submit" class="submit-btn">Добавить</button>
            </form>
        </div>
    </div>

    <!-- Модальное окно редактирования -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('editModal')">&times;</span>
            <h2>Редактировать клиента</h2>
            <form id="editForm">
                <input type="hidden" id="editClientId">
                <div class="form-group">
                    <label for="editName">ФИО:</label>
                    <input type="text" id="editName" required>
                </div>
                <div class="form-group">
                    <label for="editPhone">Телефон:</label>
                    <input type="text" id="editPhone" required>
                </div>
                <button type="submit" class="submit-btn">Сохранить</button>
            </form>
        </div>
    </div>

    <!-- Модальное окно подтверждения удаления -->
    <div id="deleteModal" class="modal">
        <div class="modal-content" style="width: 30%;">
            <span class="close" onclick="closeModal('deleteModal')">&times;</span>
            <h2>Подтверждение удаления</h2>
            <p>Вы уверены, что хотите удалить этого клиента?</p>
            <div style="text-align: right; margin-top: 20px;">
                <button type="button" class="edit-btn" onclick="closeModal('deleteModal')" style="margin-right: 10px;">
                    Отмена
                </button>
                <button type="button" class="delete-btn" id="confirmDeleteBtn">
                    Удалить
                </button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            document.querySelectorAll("tbody td:nth-child(2)").forEach(function(td) {
                let raw = td.textContent.replace(/\D/g, ''); // Очищаем от всего кроме цифр
                if (raw.length === 11) {
                    let formatted = `+7(${raw.slice(1,4)})-${raw.slice(4,7)}-${raw.slice(7,9)}-${raw.slice(9,11)}`;
                    td.textContent = formatted;
                }
            });
        });

        // Общие функции для работы с модальными окнами
        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Закрытие при клике вне модального окна
        window.onclick = function(event) {
            if (event.target.className === 'modal') {
                const modals = document.getElementsByClassName('modal');
                for (let modal of modals) {
                    modal.style.display = 'none';
                }
            }
        }

        // Функция открытия модального окна редактирования
        function openEditModal(button) {
            document.getElementById('editClientId').value = button.getAttribute('data-id');
            document.getElementById('editName').value = button.getAttribute('data-name');
            document.getElementById('editPhone').value = button.getAttribute('data-phone');
            openModal('editModal');
        }

        // Обработчик формы добавления
        document.getElementById('addForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const name = document.getElementById('addName').value;
            const phone = document.getElementById('addPhone').value;

            if (!name || !phone) {
                alert('Заполните все поля');
                return;
            }

            try {
                const response = await fetch('/api/clients', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        name: name,
                        phoneNumber: phone
                    })
                });

                if (response.ok) {
                    const newClient = await response.json();
                    addClientToTable(newClient);
                    closeModal('addModal');
                    document.getElementById('addForm').reset();
                    alert('Клиент успешно добавлен!');
                } else {
                    alert('Ошибка при добавлении клиента: ' + await response.text());
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Произошла ошибка при добавлении');
            }
        });

        // Функция для добавления клиента в таблицу
        function addClientToTable(client) {
            const tbody = document.querySelector('table tbody');
            const newRow = document.createElement('tr');
            newRow.setAttribute('data-id', client.id);

            newRow.innerHTML = `
                <td>${client.name}</td>
                <td>${client.phoneNumber}</td>
                <td>
                    <button class="edit-btn"
                            data-id="${client.id}"
                            data-name="${client.name}"
                            data-phone="${client.phoneNumber}"
                            onclick="openEditModal(this)">
                        Редактировать
                    </button>
                    <button class="delete-btn"
                            data-id="${client.id}"
                            onclick="confirmDelete(this)">
                        Удалить
                    </button>
                </td>
            `;

            tbody.appendChild(newRow);
        }

        // Обработчик формы редактирования
        document.getElementById('editForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const clientId = document.getElementById('editClientId').value;
            const name = document.getElementById('editName').value;
            const phone = document.getElementById('editPhone').value;

            try {
                const response = await fetch(`/api/clients/${clientId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        name: name,
                        phoneNumber: phone
                    })
                });

                if (response.ok) {
                    const row = document.querySelector(`tr[data-id="${clientId}"]`);
                    if (row) {
                        row.cells[0].textContent = name;
                        row.cells[1].textContent = phone;
                        // Обновляем data-атрибуты кнопки редактирования
                        const editBtn = row.querySelector('.edit-btn');
                        editBtn.setAttribute('data-name', name);
                        editBtn.setAttribute('data-phone', phone);
                    }
                    closeModal('editModal');
                    alert('Данные успешно обновлены!');
                } else {
                    alert('Ошибка при обновлении данных');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Произошла ошибка при отправке данных');
            }
        });

        // Логика удаления клиента
        let clientIdToDelete = null;

        function confirmDelete(button) {
            clientIdToDelete = button.getAttribute('data-id');
            openModal('deleteModal');
        }

        document.getElementById('confirmDeleteBtn').addEventListener('click', async function() {
            if (!clientIdToDelete) return;

            try {
                const response = await fetch(`/api/clients/${clientIdToDelete}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    const row = document.querySelector(`tr[data-id="${clientIdToDelete}"]`);
                    if (row) {
                        row.remove();
                    }
                    alert('Клиент успешно удален!');
                } else {
                    alert('Ошибка при удалении клиента');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Произошла ошибка при удалении');
            } finally {
                closeModal('deleteModal');
                clientIdToDelete = null;
            }
        });
    </script>
</main>
</body>
</html>