<!DOCTYPE html>
<html lang="ru"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">

<head>
    <link rel="stylesheet" th:href="@{/houses.css}">
<!--    <script th:src="@{/houses.js?v=2}"></script>-->
    <title> Дома </title>
</head>

<body>
<section layout:fragment="content">

    <h1>Список домов</h1>
    <br>
    <button class="add-btn" onclick="openModal('addModal')">Добавить дом</button>

    <table>
        <thead>
        <tr>
            <th>Название</th>
            <th>Цена</th>
            <th>Действия</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="house : ${houses}" th:attr="data-id=${house.id}">
            <td th:text="${house.name}"></td>
            <td th:text="${house.price % 1 == 0} ? ${#numbers.formatDecimal(house.price, 0, 0)} : ${#numbers.formatDecimal(house.price, 2, 2)}"></td>
            <td>
                <button class="edit-btn"
                        th:attr="data-id=${house.id}, data-name=${house.name}, data-price=${house.price}"
                        onclick="openEditModal(this)">
                    <i class="bi bi-pencil"></i>
                </button>
                <button class="delete-btn"
                        th:attr="data-id=${house.id}"
                        onclick="confirmDelete(this)">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
        </tr>
        </tbody>
    </table>

    <!-- Модальные окна -->
    <div id="addModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('addModal')">&times;</span>
            <h2>Добавить дом</h2>
            <form id="addForm">
                <div class="form-group">
                    <label for="addName">Название:</label>
                    <input type="text" id="addName" required>
                </div>
                <div class="form-group">
                    <label for="addPrice">Цена:</label>
                    <input type="number" id="addPrice" step="0.01" min="0" required>
                </div>
                <button type="submit" class="submit-btn">Добавить</button>
            </form>
        </div>
    </div>

    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('editModal')">&times;</span>
            <h2>Редактировать дом</h2>
            <form id="editForm">
                <input type="hidden" id="editHouseId">
                <div class="form-group">
                    <label for="editName">Название:</label>
                    <input type="text" id="editName" required>
                </div>
                <div class="form-group">
                    <label for="editPrice">Цена:</label>
                    <input type="number" id="editPrice" step="0.01" min="0" required>
                </div>
                <button type="submit" class="submit-btn">Сохранить</button>
            </form>
        </div>
    </div>

    <div id="deleteModal" class="modal">
        <div class="modal-content" style="width: 30%;">
            <span class="close" onclick="closeModal('deleteModal')">&times;</span>
            <h2>Подтверждение удаления</h2>
            <p>Вы уверены, что хотите удалить этот дом?</p>
            <div style="text-align: right; margin-top: 20px;">
                <button type="button" class="edit-btn" onclick="closeModal('deleteModal')" style="margin-right: 10px;">
                    Отмена
                </button>
                <button type="button" class="delete-btn" id="confirmDeleteBtn">
                    Удалить
                </button>
            </div>
        </div>
    </div>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // Форматирование цены (добавление знака рубля)
            document.querySelectorAll("tbody td:nth-child(2)").forEach(function (td) {
                const price = parseFloat(td.textContent);
                if (!isNaN(price)) {
                    td.textContent = formatPrice(price);
                }
            });
        });

        function formatPrice(price) {
            return price.toLocaleString('ru-RU', {
                style: 'currency',
                currency: 'RUB',
                minimumFractionDigits: price % 1 === 0 ? 0 : 2
            });
        }

        // Общие функции для работы с модальными окнами
        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Закрытие при клике вне модального окна
        window.onclick = function (event) {
            if (event.target.className === 'modal') {
                const modals = document.getElementsByClassName('modal');
                for (let modal of modals) {
                    modal.style.display = 'none';
                }
            }
        }

        // Функция открытия модального окна редактирования
        function openEditModal(button) {
            document.getElementById('editHouseId').value = button.getAttribute('data-id');
            document.getElementById('editName').value = button.getAttribute('data-name');
            document.getElementById('editPrice').value = button.getAttribute('data-price');
            openModal('editModal');
        }

        // Обработчик формы редактирования
        document.getElementById('editForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const houseId = document.getElementById('editHouseId').value;
            const name = document.getElementById('editName').value;
            const price = parseFloat(document.getElementById('editPrice').value);

            try {
                const response = await fetch(`/api/houses/${houseId}?name=${encodeURIComponent(name)}&price=${encodeURIComponent(price)}`, {
                                    method: 'PUT'
                })

                if (response.ok) {
                    const row = document.querySelector(`tr[data-id="${houseId}"]`);
                    if (row) {
                        row.cells[0].textContent = name;
                        row.cells[1].textContent = formatPrice(price);
                        const editBtn = row.querySelector('.edit-btn');
                        editBtn.setAttribute('data-name', name);
                        editBtn.setAttribute('data-price', price);
                    }
                    closeModal('editModal');
                    alert('Данные успешно обновлены!');
                } else {
                    alert('Ошибка при обновлении данных');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Произошла ошибка при отправке данных');
            }
        });

        // Обработчик формы добавления
        document.getElementById('addForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const name = document.getElementById('addName').value;
            const price = parseFloat(document.getElementById('addPrice').value);

            if (!name || isNaN(price)) {
                alert('Заполните все поля корректно');
                return;
            }

            try {
                const response = await fetch('/api/houses', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        name: name,
                        price: price
                    })
                });

                if (response.ok) {
                    const newHouse = await response.json();
                    addHouseToTable(newHouse);
                    closeModal('addModal');
                    document.getElementById('addForm').reset();
                    alert('Дом успешно добавлен!');
                } else {
                    alert('Ошибка при добавлении дома: ' + await response.text());
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Произошла ошибка при добавлении');
            }
        });

        // Функция для добавления дома в таблицу
        function addHouseToTable(house) {
            const tbody = document.querySelector('table tbody');
            const newRow = document.createElement('tr');
            newRow.setAttribute('data-id', house.id);

            newRow.innerHTML = `
                <td>${house.name}</td>
                <td>${formatPrice(house.price)}</td>
                <td>
                    <button class="edit-btn"
                            data-id="${house.id}"
                            data-name="${house.name}"
                            data-price="${house.price}"
                            onclick="openEditModal(this)">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button class="delete-btn"
                            data-id="${house.id}"
                            onclick="confirmDelete(this)">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
            `;

            tbody.appendChild(newRow);
        }

        // Логика удаления дома
        let houseIdToDelete = null;

        function confirmDelete(button) {
            houseIdToDelete = button.getAttribute('data-id');
            openModal('deleteModal');
        }

        document.getElementById('confirmDeleteBtn').addEventListener('click', async function () {
            if (!houseIdToDelete) return;

            try {
                const response = await fetch(`/api/houses/${houseIdToDelete}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    const row = document.querySelector(`tr[data-id="${houseIdToDelete}"]`);
                    if (row) {
                        row.remove();
                    }
                    alert('Дом успешно удален!');
                } else {
                    alert('Ошибка при удалении дома');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Произошла ошибка при удалении');
            } finally {
                closeModal('deleteModal');
                houseIdToDelete = null;
            }
        });
    </script>
</section>
</body>
</html>